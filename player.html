<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream with Uploads</title>
    <style>
        body { 
            background: #000; color: #fff; font-family: sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            min-height: 100vh; margin: 0; 
        }
        video { width: 80%; max-width: 1000px; border-radius: 8px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .control-panel { margin-top: 20px; background: #222; padding: 15px; border-radius: 15px; display: flex; flex-direction: column; gap: 15px; align-items: center; width: 80%; max-width: 1000px; }
        .debug-info { color: #ffff00; font-family: monospace; margin-bottom: 10px; background: #333; padding: 5px 10px; border-radius: 4px; }

        .sub-controls { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; align-items: center; }
        button { background: #444; color: white; border: none; padding: 8px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 13px; font-family: monospace; }
        button:hover { background: #666; }
        .btn-minus { border-bottom: 2px solid #ff4d4d; }
        .btn-plus { border-bottom: 2px solid #4dff88; }
        .delay-display { font-family: monospace; font-size: 18px; color: #4da6ff; min-width: 90px; text-align: center; font-weight: bold; }
        
        /* Action Bar (Download + Upload) */
        .action-bar { display: flex; gap: 15px; width: 100%; justify-content: center; }
        .btn-action { background: #28a745; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; cursor: pointer; border: none; font-size: 14px; font-family: sans-serif; }
        .btn-upload { background: #007bff; }
        .btn-action:hover { transform: scale(1.05); }

        /* Hidden File Input */
        #fileInput { display: none; }
    </style>
</head>
<body>

    <div id="debugDisplay" class="debug-info">Checking URL...</div>

    <video id="player" controls autoplay width="80%" crossorigin="anonymous">
        <track id="subTrack" label="English" kind="subtitles" srclang="en" default>
    </video>

    <div class="control-panel">
        
        <div class="sub-controls">
            <span style="margin-right: 10px; color: #aaa;">Sync:</span>
            <button class="btn-minus" onclick="changeDelay(-500)">-0.5s</button>
            <button class="btn-minus" onclick="changeDelay(-100)">-0.1s</button>
            <button class="btn-minus" onclick="changeDelay(-50)">-0.05s</button>
            <span id="currentDelay" class="delay-display">0 ms</span>
            <button class="btn-plus" onclick="changeDelay(50)">+0.05s</button>
            <button class="btn-plus" onclick="changeDelay(100)">+0.1s</button>
            <button class="btn-plus" onclick="changeDelay(500)">+0.5s</button>
        </div>

        <div class="action-bar">
            <button class="btn-action btn-upload" onclick="document.getElementById('fileInput').click()">
                üìÅ Upload Subs
            </button>
            <input type="file" id="fileInput" accept=".vtt,.srt">

            <a id="downloadLink" href="#" class="btn-action">
                ‚ö° Download Video
            </a>
        </div>

    </div>

    <script>
        const BASE_URL = "https://islands-insights-calm-screens.trycloudflare.com";
        const DEFAULT_ID = '1CwKOe66qu484pJoFcvqNrdI8IItyif36'; 

        const video = document.getElementById('player');
        const track = document.getElementById('subTrack');
        const downloadBtn = document.getElementById('downloadLink');
        const debugBox = document.getElementById('debugDisplay');
        const display = document.getElementById('currentDelay');
        const fileInput = document.getElementById('fileInput');
        
        const urlParams = new URLSearchParams(window.location.search);
        let activeFileId = urlParams.get('id');

        if (activeFileId) {
            debugBox.innerText = `‚úÖ Playing: ${activeFileId}`;
            debugBox.style.color = "#4dff88";
        } else {
            activeFileId = DEFAULT_ID;
            debugBox.innerText = `‚ö†Ô∏è No ID. Using Default.`;
            debugBox.style.color = "#ffff00";
        }

        // Apply Sources
        video.src = `${BASE_URL}/video/${activeFileId}`;
        downloadBtn.href = `${BASE_URL}/download/${activeFileId}`;
        
        // Load the specific subtitle for this video ID
        // The server looks for "VIDEO_ID.vtt"
        track.src = `${BASE_URL}/adjust-sub/${activeFileId}.vtt?delay=0`;
        video.load();

        // --- UPLOAD LOGIC ---
        fileInput.addEventListener('change', async () => {
            if (fileInput.files.length === 0) return;
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('subtitle', file);

            debugBox.innerText = "‚è≥ Uploading Subtitle...";
            debugBox.style.color = "#4da6ff";

            try {
                // Upload to server
                const res = await fetch(`${BASE_URL}/upload-sub/${activeFileId}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (res.ok) {
                    debugBox.innerText = "‚úÖ Subtitle Uploaded! Reloading...";
                    debugBox.style.color = "#4dff88";
                    
                    // Refresh the track source immediately
                    const newUrl = `${BASE_URL}/adjust-sub/${activeFileId}.vtt?delay=${currentDelay}&t=${Date.now()}`;
                    track.src = newUrl;
                    
                    // Simple alert
                    alert("Subtitle uploaded! It should appear now.");
                } else {
                    throw new Error("Server rejected upload");
                }
            } catch (err) {
                debugBox.innerText = "‚ùå Upload Failed";
                debugBox.style.color = "#ff4d4d";
                console.error(err);
            }
        });

        // --- SYNC CONTROL ---
        let currentDelay = 0;
        function changeDelay(ms) {
            currentDelay += ms;
            display.innerText = (currentDelay > 0 ? "+" : "") + currentDelay + " ms";
            if (currentDelay === 0) display.style.color = "#4da6ff"; 
            else if (currentDelay > 0) display.style.color = "#4dff88"; 
            else display.style.color = "#ff4d4d"; 

            // Update Track with specific ID and delay
            const newUrl = `${BASE_URL}/adjust-sub/${activeFileId}.vtt?delay=${currentDelay}&t=${Date.now()}`;
            track.src = newUrl;

            if (video.textTracks[0]) {
                const mode = video.textTracks[0].mode;
                video.textTracks[0].mode = 'disabled';
                setTimeout(() => { video.textTracks[0].mode = mode; }, 50);
            }
        }
    </script>

</body>
</html>
